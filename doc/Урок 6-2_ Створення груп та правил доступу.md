# Створення груп та правил доступу

1. # Безпека та розмежування прав в Odoo

В системі Odoo реалізовано два механізми для керування правами доступу. Обидва механізми використовують таку сутність, як групи користувача, у якості обмежувача прав.

Як це працює? З одного боку механізми розмежування прав використовують групи для надання або обмеження доступу, з іншого \- кожний користувач має певний набір груп, до котрих він входить. При цьому, користувач може входити до будь-якої кількості груп.

## Групи користувачів

Для додання груп користувачів у рішення на базі Odoo використовується модель **res.groups**. При створенні запису з групою необхідно вказати наступні поля:

* **name** \- назва ролі користувача;

* **category\_id** \- категорія груп, котра об’єднує групи, що додаються, та дозволяє будувати ієрархічну структуру;

* **implied\_ids** \- список інших груп системи, до котрих користувача буде додано автоматично, при включенні у поточну групу.

* **users** \- список користувачів, котрих потрібно додати до цієї групи за замовчуванням. Зазвичай, додаються системні користувачі: *Суперюзер* (base.user\_root) та *Адміністратор системи* (base.user\_admin).

* **comment** \- пояснення, для чого призначена ця група, та які має права та обмеження.

Зазвичай, при додаванні власних груп користувачів у модуль, що розробляється, використовується щонайменш дві ролі: користувач \- обмежена роль для модуля, та менеджер (або адміністратор) \- користувач з повними правами на модуль.

Групи користувачів, згідно з рекомендаціями Odoo, повинні додаватися за допомогою XML файлу **\<module\>\_groups.xml**, який повинен бути розташований у директорії **security**. 

2. # Права доступу

Першочергово, доступ до записів моделей визначається за допомогою прав доступу, котрі у системі Odoo зберігаються у моделі **ir.model.access** та мають наступні поля:

* **name** \- зрозуміла назва прав доступу;

* **model\_id** \- модель системи, котрої стосуються дані права;

* **group\_id** \- група користувачів, для якої застосовуються права;

* **perm\_read** \- бульовий атрибут, котрий дає право на читання запису;

* **perm\_write** \- бульовий атрибут, котрий дає право на зміну запису;

* **perm\_create** \- бульовий атрибут, котрий дає право на створення запису;

* **perm\_unlink** \- бульовий атрибут, котрий дає право на видалення запису.

Права визначені таким чином є базовими, а всі подальші обмеження накладаються лише поверх них.

Права доступу обов’язково потрібно надавати для кожної нової стандартної (models.Model) або тимчасової (models.TransientModel) моделі.

Права доступу тільки додають права для групи, за їх допомогою неможливо обмежити вже існуючі права користувача, надані за допомогою іншої групи.

|  group | create | read | update | delete |
| :---: | :---: | :---: | :---: | :---: |
| A | X | X |  |  |
| B |  | X |  |  |
| C |  |  | X |  |

Тобто, користувач, котрий входить до груп **A** та **C**, має на об’єкт всі права, крім видалення, а користувач що входить до груп **B** та **C**, може лише читати та оновлювати записи моделі.

Права доступу, згідно з рекомендаціями Odoo, повинні додаватися за допомогою CSV файлу **ir.model.access.csv**, котрий повинен бути розташований у директорії **security**. 

3. # Правила записів

Правила записів \-  це другий механізм обмежень, заснований на групах користувачів. За замовчуванням, користувачі, котрі належать до певних груп, мають усі дозволи від цих груп.

У випадках, коли потрібно обмежити ці дозволи при виконанні певних умов, додають правила записів.

Правила записів \- це своєрідний фільтр, котрий звужує права, надані за допомогою прав доступу. Наприклад, є два користувачі **A** та **B** з однаковими правами (мають однаковий набір груп) і потрібно обмежити їх таким чином, щоб кожний міг бачити лише власні записи:

| User | Group | Records (without rule) | Record Rule Domain | Records (with rule) |
| :---: | :---: | :---: | :---: | :---: |
| A | U | 100 | (‘user\_id”, ‘=’, user.id) | 9 |
| B | U | 100 | (‘user\_id”, ‘=’, user.id) | 17 |

Для більш “тонкого” налаштування правила запису можна вказати, на які саме операції воно застосовується. Так, у поточному прикладі ми можемо вказати, що правило повинно застосовуватися лише на операції читання:

* perm\_read \= True

* perm\_write \= False

* perm\_create \= False

* perm\_unlink \= False

Якщо явно не вказувати ці параметри, то правило записів буде застосовано для всіх операцій: читання, внесення змін, створення та видалення.

Згідно з цим прикладом, якби ми не додали правило запису, то кожний з користувачів міг бачити всі 100 записів. Але після додавання, кожний користувач має можливість бачити лише ті записи, де він встановлений як відповідальний. Тобто користувачі **A** та **B** \- це користувачі з обмеженими правами. 

Якщо правило доступу було додано для однієї з базових груп користувачів, скоріш за все буде потрібно прибрати його для адміністраторів системи або користувачів з розширеними правами. Для цього використовується спеціальний домен, котрий завжди є істиною:

| User | Group | Records (without rule) | Record Rule Domain | Records (with rule) |
| :---: | :---: | :---: | :---: | :---: |
| C | M | 100 | (1, ‘=’, 1\) | 100 |

У цьому випадку ми розширюємо права для певної групи, які були звужені іншим правилом.

## Глобальні правила записів

Глобальні правила записів діють на рівні всієї системи, а не на рівні груп користувачів. Вони є обмеженнями, і їх не можна обійти. 

Алгоритм накладення правил:

GLOBAL\_RULE\_1 **AND** GLOBAL\_RULE\_2 **AND** (   
    (GROUP\_A\_RULE\_1 **OR** GROUP\_A\_RULE\_2) **OR**  
    (GROUP\_B\_RULE\_1 **OR** GROUP\_B\_RULE\_2)   
)

Зразок XML файлу для додання правила записів:

**\<record** id="rule\_id" model="ir.rule"**\>**  
    **\<field** name="name"**\>**A description of the rule's role**\</field\>**  
    **\<field** name="model\_id" ref="model\_to\_manage"**/\>**  
    **\<field** name="global" eval="False"**/\>**  
    **\<field** name="domain\_force"**\>**\[  
        '|', ('user\_id', '=', user.id),  
             ('user\_id', '=', False)  
    \]**\</field\>**  
    **\<field** name="groups" eval="\[(4, ref('base.group\_user'))\]"**/\>**  
    **\<field** name="perm\_read" eval="False"**/\>**  
**\</record\>**

Поля правила записів:

* **name** \- зрозуміла назва правила записів;

* **model\_id** \- модель, до котрої буде застосовано правило;

* **groups** \- групи користувачів, до котрих буде застосовано правило;

* **domain\_force** \- умова (фільтр), при виконанні котрої користувачі груп отримають дозвіл на операції над об’єктом;

* **global** \- ознака глобального правила записів. Якщо до правила не додано ні однієї групи користувачів, воно також буде вважатися глобальним.

* **perm\_read** \- визначає, чи застосовувати поточне правило на операції читання. За замовчуванням, \- так (True);

* **perm\_write** \- визначає, чи застосовувати поточне правило на операції внесення змін. За замовчуванням, \- так (True);

* **perm\_create** \- визначає, чи застосовувати поточне правило на операції створення. За замовчуванням, \- так (True);

* **perm\_unlink** \- визначає, чи застосовувати поточне правило на операції видалення. За замовчуванням, \- так (True).

# Правила записів, згідно з рекомендаціями Odoo, повинні додаватися за допомогою XML файлів **\<model\>\_security.xml**, котрі повинні бути розташовані у директорії **security**. 

4. # Перевірка прав безпеки та її пропуск

У деяких випадках буває потрібно обійти існуючі права для конкретних груп користувачів, або виконати деякий метод, недоступний для поточного користувача. У системі Odoo існують спеціальні методи для цих операцій.

Методи для перевірки прав доступу:

* **self.env.user.has\_group()** \- перевірка, що поточний користувач входить до певної групи;

* **self.check\_access\_rights(operation)** \- перевірка, що поточний користувач має права доступу на модель, де *operation*, це один з методів:  
  * read  
  * write  
  * create  
  * unlink

* **self.check\_access\_rule(operation)** \- перевірка, що поточному користувачу дозволено виконувати операцію для кожного запису з набору.

Для виконання операцій, оминаючи перевірки прав доступу, застосовується метод **sudo()**. При застосуванні цього методу, запуск методу або доступ до записів відбувається таким самим чином, якби його виконував адміністратор системи. 

Застосовувати метод **sudo()** потрібно дуже обережно, розуміючи усі наслідки його використання.

# 

# Додаткові матеріали до уроку

* Security in Odoo: [https://www.odoo.com/documentation/15.0/developer/reference/addons/security.html](https://www.odoo.com/documentation/14.0/developer/reference/addons/security.html)  
* Chapter 5: Security \- A Brief Introduction: [https://www.odoo.com/documentation/15.0/developer/howtos/rdtraining/05\_securityintro.html](https://www.odoo.com/documentation/15.0/developer/howtos/rdtraining/05_securityintro.html)  
* Advanced B: ACL and Record Rules: [https://www.odoo.com/documentation/15.0/developer/howtos/rdtraining/B\_acl\_irrules.html](https://www.odoo.com/documentation/15.0/developer/howtos/rdtraining/B_acl_irrules.html)  
* Odoo Guidelines: [https://www.odoo.com/documentation/15.0/developer/misc/other/guidelines.html](https://www.odoo.com/documentation/15.0/developer/misc/other/guidelines.html)  
    
    
  