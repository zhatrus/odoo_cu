# Написання тестів

1. # Види тестів у системі Odoo

У системі Odoo є три види тестів:

* **Юніт тести Python** коду;  
* **Юніт тести JS** коду;  
* **Тури** \- інтеграційні тести, котрі симулюють реальну ситуацію при роботі з системою. 

У даному уроці ми будемо розглядати перший вид тестів \- **Python unit tests**.

2. # Додавання Python тестів 

Odoo забезпечує тестування модулів за допомогою [Python бібліотеки unnittest](https://docs.python.org/3/library/unittest.html). Файли з тестами повинні бути розташовані у директорії **tests**, котру створюють у кореневій директорії модуля:

your\_module  
├── ...  
├── tests  
|   ├── \_\_init\_\_.py  
|   ├── test\_bar.py  
|   └── test\_foo.py

Файл **\_\_init\_\_.py**, розташований у директорії **tests**, повинен містити рядки з імпортом Python файлів. Якщо файл з тестами не додано до файлу **\_\_init\_\_.py**, то ці тести не будуть виконані. 

from . import test\_foo  
from . import test\_bar

Зверніть увагу, додавати рядок з імпортом директорії **tests** до кореневого файлу **\_\_init\_\_.py**, розташованого у корені модуля, не потрібно.

Назва кожного файлу з тестами повинна починатися з префіксу “**test\_**”. 

Методи, котрі містять логіку тестування, також повинні мати назву, котра починається з такого ж префіксу. У випадку, якщо важливо визначити черговість виконання тестових методів, можна додавати числову послідовність у найменування методів:

def test\_**01**\_base\_case():  
def test\_**02**\_extended\_case():  
def test\_**03**\_…

***Рекомендації:***

* Розділяйте тести на окремі файли, в залежності від цілей тестування.  
* Створюйте окремий загальний клас, котрий може бути успадкованим усіма іншими тестами. Назву такому файлу зазвичай дають: **common.py**.

3. # Класи Python тестів

Розглянемо класи, котрі використовуються при написанні тестів:

* **TransactionCase**;  
* **SingleTransactionCase**;  
* **HttpCase**.

Клас odoo.tests.common.**TransactionCase** дозволяє виконувати всі методи за одну транзакцію, при цьому кожний метод виконується у підтранзакції, що зберігається за допомогою savepoint проміжні результати успішно виконаного методу. Після виконання транзакції курсор зачиняється без збереження результатів (commit не виконується).

Клас odoo.tests.common.**SingleTransactionCase** виконує усі методи за одну транзакцію. Транзакція починається при запуску першого методу та відкочується після виконання останнього методу.

Клас odoo.tests.common.**HttpCase** дозволяє виконувати тести з боку браузера Google Chrome, а не з Python коду. Тобто за допомогою цього класу є можливість виконувати певні дії через браузер, після чого використовувати отримані результати у тестовому методі.  
 

## Спеціальний клас Form

Клас odoo.tests.common.**Form,** це представлення форми моделі на боці сервера. Цей клас дозволяє встановлювати та змінювати значення полів форми та моделювати операції користувача на формі. Дозволяє також перевіряти коректність роботи методів **default\_get** та **onchange**, обробляти ці ж самі методи для присутніх на формі полів з типами **Many2many** та **One2many**.

Метод default\_get викликається у момент створення форми.  
Відповідні методи onchange викликаються у момент створення форми, і також у момент встановлення значень полів.

Методи класу Form:

* save() \- зберігає форму, повертає посилання на створений запис.

4. # Загальні методи

setUpClass() \- метод, котрий викликається перед виконанням тестових методів. До даного методу необхідно застосовувати декоратор @classmethod.  
setUp() \- дозволяє виконувати певні дії перед виконанням тестового методу.  
tearDown() \- дозволяє виконувати певні дії після виконанням тестового методу.  
tearDownClass() \- метод, котрий викликається після виконання всіх тестових методів. До даного методу необхідно застосовувати декоратор @classmethod.

| TransactionCase |
| ----- |
| setUpClass() setUp() test\_method\_1() tearDown() setUp() test\_method\_2() tearDown() … tearDownClass() |

Використання методу setUpClass() бажано для додання або внесення змін до загальних даних для всіх тестових методів, це дозволить уникнути дублювання коду та зменшить час виконання тестів.

# 

5. # Запуск тестів

Розглянемо два шляхи, котрі дозволяють запускати тести:

* за допомогою стандартного скрипту **odoo-bin**;  
* за допомогою скрипту **odoo-helper**.

## Запуск тестів стандартним шляхом

Для запуску тестів за допомогою стандартного скрипту **odoo-bin** використовується наступний синтаксис:  
odoo-bin \-d demo \-u module\_name \--test-enable \\  
\--log-level=test \--stop-after-init

Де можуть бути використані додаткові ключі:

* **\--test-enable** \- вказує, що потрібно запустити тести.  
* **\--test-tags=\<tag\_name\>** \- вказує назви тегів, котрими позначені тести, що мають бути запущені. Використовується для вибіркового запуску певних тестів. При використанні даного ключа додатково вказувати ключ \--test-enable не потрібно.  
* **\--log-level=test** \- перемикає рівень логування на необхідний для запуску тестів.  
* **\--stop-after-init** \- вказує на необхідність зупинити роботу скрипту після виконання всіх тестів.

## Запуск тестів за допомогою odoo-helper

Скрипт **odoo-helper** має наступні команди для запуску тестів:

* odoo-helper test \-m \<module\>   
  \- запуск тестів для певного модуля.  
* odoo-helper test \--dir .   
  \- запуск тестів для всіх модулів у певній директорії.

Додаткові ключі:

* **\--coverage-html** \- створити html звіт покриття модуля тестами.  
* **\--recreate-db** \- перестворити базу даних перед запуском тестів.  
* **\--create-test-db** \- створити нову базу даних для тестування, котра буде видалена по завершенню виконання тестів.

Інші ключі, котрі можуть бути використані у поточному режимі роботи скрипту, можна переглянути за допомогою команди:  
odoo-helper test **\--help**

Приклади:  
odoo-helper test **\--coverage-html** \-m \<module\>  
odoo-helper test \-m \<module\> **\--recreate-db**  
odoo-helper test \-m \<module\> **\--create-test-db**

6. # Теги тестів

При написанні тестів є можливість додавати теги. Теги є своєрідними фільтрами, що дозволяють визначити, які саме тести потрібно виконувати.

Теги до тестів додаються за допомогою декоратора **tagged()**, аргументами котрого є назви тегів:

from odoo.tests import TransactionCase, **tagged**

**@tagged('-standard', 'nice')**  
class NiceTest(TransactionCase):  
    ...

При додаванні тегів є можливість або додавати їх, або вимикати. Це робиться шляхом додавання префіксу "**\-**" до тих тегів, котрі необхідно вимкнути. Наприклад, додаючи тег "\-standard" ми вказуємо, що не потрібно запускати стандартні тести модуля.

Спеціальні теги:

* **standard** \- цей тег охоплює всі тести, які успадковані від загального класу BaseCase. Тобто його мають всі тести, у котрих явно не визначені інші теги. При використанні ключа \--test-tags, цей тег використовується за замовчуванням.   
* **at\_install** \- цей тег означає що тест буде виконано відразу після встановлення модуля, до встановлення інших наступних модулів. Ця поведінка використовується за замовчуванням.  
* **post\_install** \- використання цього тегу означає, що тест буде виконано тільки після встановлення всіх модулів. Цей тег часто використовують для тестів класу HttpCase.   
  Даний тег, зазвичай, використовують у парі з тегом at\_install, додаючи до нього символ “-”:   
  **\-at\_install**, це означає, що виконувати тест потрібно лише один раз після встановлення всіх модулів.

При додаванні ключа \--test-tags може бути використаний наступний синтаксис:  
\--test-tags \[-\]\[tag\]\[/module\]\[:class\]\[.method\]

Приклади використання тегів при запуску тестів:

* odoo-bin \-d demo **\--test-tags** library  
  \- виконання всіх тестів з тегом “library”.

* odoo-bin \-d demo **\--test-tags=**\-access/school\_lesson\_6\_4  
  \- виконання всіх тестів у модулі "school\_lesson\_6\_4" за винятком помічених тегом “access”.

* odoo-bin \-d demo **\--test-tags**\=-access,library/school\_lesson\_6\_4  
  \- виконання всіх тестів помічених тегами "library", виключаючи помічені тегами "access" у модулі "school\_lesson\_6\_4".

* odoo-bin \-d demo **\--test-tags**\=/school\_lesson\_6\_4:TestForm  
  \- виконання всіх тестових методів у класі "TestForm" у модулі "school\_lesson\_6\_4".

* odoo-bin \-d demo **\--test-tags**\=/school\_lesson\_6\_4:TestAccessRights.test\_02\_library\_admin\_access\_rights  
  \- виконання тестового методу "test\_02\_library\_admin\_access\_rights"  у класі "TestAccessRights" у модулі "school\_lesson\_6\_4".




  # 

7. # Правила та рекомендації при написанні тестів

При написанні тестів рекомендується дотримуватися наступних правил:

* Тести повинні бути незалежними від даних у базі даних (включаючі демо дані).  
* Тести не повинні впливати будь яким шляхом на дані в базі даних. Це зазвичай реалізовано шляхом скасуванням всіх тестових транзакцій по завершенню виконання тестів.  
* Для перевірки того, що баг був виправлений, тест не повинен пройти до виправлення бага, та повинен бути успішним, після виправлення бага.  
* Не потрібно тестувати те, що вже протестовано у іншому тесті. Тести бізнес модулів, зазвичай повинні тестувати лише виконання бізнес процесів.  
* Не потрібно зберігати будь які дані у базі даних.

# 

# Додаткові матеріали до уроку

* Testing Odoo: [https://www.odoo.com/documentation/15.0/developer/reference/backend/testing.html](https://www.odoo.com/documentation/15.0/developer/reference/backend/testing.html)  
* Advanced E: Python Unit Tests: [https://www.odoo.com/documentation/15.0/developer/howtos/rdtraining/E\_unittest.html](https://www.odoo.com/documentation/15.0/developer/howtos/rdtraining/E_unittest.html)  
* OCA Days 2020 \- Simone Orsi: Testing best practices, tips and tricks: [https://www.youtube.com/watch?v=pQ7TZELSpKY](https://www.youtube.com/watch?v=pQ7TZELSpKY)  
* Odoo's Test Framework: Learn Best Practices: [https://www.youtube.com/watch?v=JEIscps0OOQ](https://www.youtube.com/watch?v=JEIscps0OOQ)  
* Writing tests in Odoo \- Organizing, Writing, and Running Automated Tests: [https://www.holdenrehg.com/blog/2019-02-02\_writing-tests-in-odoo](https://www.holdenrehg.com/blog/2019-02-02_writing-tests-in-odoo)  
*   
    
    
  